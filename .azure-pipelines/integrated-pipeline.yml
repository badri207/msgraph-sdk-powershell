# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

name: 'Integrated Pipeline'
variables:
    BRANCH: 'weeklyOpenApiDocsDownload'
    GitUserEmail: 'GraphTooling@service.microsoft.com'
    GitUserName: 'Microsoft Graph DevX Tooling'
    BaseBranch: 'dev'
    AUTH_MODULE_NAME: 'Authentication'
    AUTH_MODULE_PATH: 'src\Authentication\Authentication\'
    AUTH_MODULE_DLL_PATTERN: 'Microsoft.Graph.Authentication.dll'
    MODULE_DLL_PATTERN: 'Microsoft.Graph.Authentication.dll'
    BETA_MODULE_PREFIX: 'Microsoft.Graph'
    ROLLUP_MODULE_NAME: 'Graph'
    ROLLUP_MODULE_PATH: 'src\'
    WORKLOAD_MODULE_PATH: 'src\'
    GRAPH_VERSION: 'beta'
    Api_Key: 'Api_Key'
  
pool:
    vmImage: 'windows-latest'
trigger:
    branches:
      include:
      - master
    paths:
      include:
      - src/Authentication/*

stages:
- stage: DownloadOpenApiDocs
  displayName: 'Download Open Api Docs from DevX API'
  jobs:
  - job: DownloadOpenAPiDocs
    steps:
    - template: ./download-openapidocs.yml
      parameters:
        GitUserEmail: $(GitUserEmail)
        GitUserName: $(GitUserName)
        BaseBranch: $(BaseBranch)

- stage: GenerateAuthModule
  displayName: 'Generate Authentication Module (Microsoft.Graph.Authentication)'
  jobs:
  - template: ./generate-auth-module.yml
    parameters:
      Api_Key: $(Api_Key)
      AUTH_MODULE_NAME: $(AUTH_MODULE)
      AUTH_MODULE_PATH: $(AUTH_MODULE_PATH)
      AUTH_MODULE_DLL_PATTERN: $(AUTH_MODULE_DLL_PATTERN)

    
- stage: GenerateBetaModules
  displayName: 'Generate Beta Modules (Microsoft.Graph.*)'
  jobs:
  - template: ./generate-beta-modules.yml
    parameters:
      Api_Key: $(Api_Key)
      BETA_MODULE_PREFIX: $(BETA_MODULE_PREFIX)
      WORKLOAD_MODULE_PATH: $(WORKLOAD_MODULE_PATH)
      GRAPH_VERSION: $(GRAPH_VERSION)
      AUTH_MODULE_PATH: $(AUTH_MODULE_PATH)
      AUTH_MODULE_DLL_PATTERN: $(AUTH_MODULE_DLL_PATTERN)

- stage: GenerateRollUpModule
  displayName: 'Generate Roll-Up Module'
  jobs:
  - template: ./generate-beta-rollup-module.yml
    parameters:
      Api_Key: $(Api_Key)
      ROLLUP_MODULE_PATH: $(ROLLUP_MODULE_PATH)
      ROLLUP_MODULE_NAME: $(ROLLUP_MODULE_NAME)
      GRAPH_VERSION: $(GRAPH_VERSION)
